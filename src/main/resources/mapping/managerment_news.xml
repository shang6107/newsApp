<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cxgc.news_app.core.mapper.managerment_system_mapper.NewsManagermentDao">

    <update id="updateReleaseById" parameterType="com.cxgc.news_app.core.model.Release">
        UPDATE `release`
        <set>
            <if test="status !=null">
                `status`=#{status.status},
            </if>
            <if test="newTypeId!= null">
                news_type_id=#{newTypeId.id},
            </if>
        </set>
        where id=#{id}
    </update>

    <resultMap id="news_result" type="com.cxgc.news_app.core.model.News">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="url" column="URL"/>
        <result property="accessCount" column="access_count"/>
        <result property="createTime" column="create_time"/>
        <association property="type" column="news_type_id" select="getNewsTypeById"/>
    </resultMap>

    <select id="selectAllNews" resultMap="news_result">
        select * from news
    </select>


    <resultMap id="release_result" type="com.cxgc.news_app.core.model.Release">
        <id property="id" column="id"/>
        <result property="createTime" column="create_time"/>
        <result property="path" column="path"/>
        <result property="accessCount" column="access_count"/>
        <result property="title" column="title"/>
        <result property="status" column="status"
                typeHandler="com.cxgc.news_app.core.config.mybatis.ReleaseTypeHandler"/>

        <association property="userId" javaType="com.cxgc.news_app.core.model.User">
            <id property="id" column="userId"/>
            <result property="phoneNum" column="phone_num"/>
            <result property="nickName" column="nick_name"/>
            <result property="password" column="password"/>
            <result property="headImg" column="head_img"/>
            <result property="gender" column="gender"/>
            <result property="address" column="address"/>
            <result property="hobby" column="Hobby"/>
            <result property="birth" column="birth"/>
            <result property="introduce" column="introduce"/>
            <result property="lastTime" column="last_time"/>
            <result property="status" column="status"
                    typeHandler="com.cxgc.news_app.core.config.mybatis.UserStatusTypeHandler"/>
            <result property="typeName" column="type_name"
                    typeHandler="com.cxgc.news_app.core.config.mybatis.UserTypeHandler"/>
            <result property="createTime" column="create_time"/>
        </association>
        <association property="newTypeId" column="news_type_id" select="getNewsTypeById"/>
    </resultMap>

    <insert id="addRelease" parameterType="com.cxgc.news_app.core.model.Release">
        insert into release(id,create_time,path,user_id,access_count,new_type_id,title,status)
        values(#{release.id},#{release.create_time},#{release.path},#{release.user_id},#{release.access_count},#{release.new_type_id},#{release.title},#{release.status})
    </insert>
    <delete id="deleteNewsById" parameterType="com.cxgc.news_app.core.model.Release">
        DELETE FROM `release` where id=#{0}
    </delete>

    <select id="selectRelease" resultMap="release_result">
        select * from `release` join users on `release`.user_Id=users.id
    </select>

    <select id="selectReleaseById" resultMap="release_result">
        select r.*,u.nick_name from `release` as r join users as u on r.user_Id=u.id WHERE r.id=#{id}
    </select>

    <resultMap id="newsTypeResult" type="com.cxgc.news_app.core.model.NewsType">
        <id property="id" column="id"/>
        <result property="typeName" column="type_name"/>
        <result property="typeDesc" column="type_desc"/>
    </resultMap>

    <select id="getNewsTypeById" resultMap="newsTypeResult">
        select * from news_type where id = #{0}
    </select>


    <!--####################新闻数据统计#######################-->
    <select id="getMaxCountOfNewsType" resultType="map">
        SELECT
        nt.type_name,
        count(news_type_id) counts
        FROM
        news n
        JOIN
        news_type nt
        ON
        n.news_type_id = nt.id
        GROUP BY
        news_type_id
        ORDER BY
        counts DESC
        LIMIT 1
    </select>
    <select id="getMinCountOfNewsType" resultType="map">
        SELECT
        nt.type_name,
        count(news_type_id) counts
        FROM
        news n
        JOIN
        news_type nt
        ON
        n.news_type_id = nt.id
        GROUP BY
        news_type_id
        ORDER BY
        counts
        LIMIT 1
    </select>
</mapper>




