<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cxgc.news_app.core.mapper.managerment_system_mapper.NewsManagermentDao">

    <update id="updateReleaseById" parameterType="com.cxgc.news_app.core.model.Release">
        UPDATE `release`
        <set>
            <if test="status !=null">
                `status`=#{status.status},
            </if>
            <if test="newTypeId!= null">
                news_type_id=#{newTypeId.id},
            </if>
        </set>
        where id=#{id}
    </update>

    <resultMap id="news_result" type="com.cxgc.news_app.core.model.News">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="url" column="URL"/>
        <result property="accessCount" column="access_count"/>
        <result property="createTime" column="create_time"/>
        <association property="type" column="news_type_id" select="getNewsTypeById"/>
    </resultMap>

    <select id="selectAllNews" resultMap="news_result">
        select * from news
    </select>


    <resultMap id="release_result" type="com.cxgc.news_app.core.model.Release">
        <id property="id" column="id"/>
        <result property="createTime" column="create_time"/>
        <result property="path" column="path"/>
        <result property="accessCount" column="access_count"/>
        <result property="title" column="title"/>
        <result property="status" column="status"
                typeHandler="com.cxgc.news_app.core.config.mybatis.ReleaseTypeHandler"/>

        <association property="userId" javaType="com.cxgc.news_app.core.model.User">
            <id property="id" column="userId"/>
            <result property="phoneNum" column="phone_num"/>
            <result property="nickName" column="nick_name"/>
            <result property="password" column="password"/>
            <result property="headImg" column="head_img"/>
            <result property="gender" column="gender"/>
            <result property="address" column="address"/>
            <result property="hobby" column="Hobby"/>
            <result property="birth" column="birth"/>
            <result property="introduce" column="introduce"/>
            <result property="lastTime" column="last_time"/>
            <result property="status" column="status"
                    typeHandler="com.cxgc.news_app.core.config.mybatis.UserStatusTypeHandler"/>
            <result property="typeName" column="type_name"
                    typeHandler="com.cxgc.news_app.core.config.mybatis.UserTypeHandler"/>
            <result property="createTime" column="create_time"/>
        </association>
        <association property="newTypeId" column="news_type_id" select="getNewsTypeById"/>
    </resultMap>

    <insert id="addRelease" parameterType="com.cxgc.news_app.core.model.Release">
        insert into release(id,create_time,path,user_id,access_count,new_type_id,title,status)
        values(#{release.id},#{release.create_time},#{release.path},#{release.user_id},#{release.access_count},#{release.new_type_id},#{release.title},#{release.status})
    </insert>

    <delete id="deleteNewsById" parameterType="com.cxgc.news_app.core.model.Release">
     DELETE FROM news where id=#{0}
    </delete>
    <select id="updateRelease" resultMap="release_result">
select * from `release` as r join users as u on r.user_Id=u.id where not r.`status`=2
</select>
    <select id="selectRelease" resultMap="release_result">
select * from `release` as r join users as u on r.user_Id=u.id where r.`status`=2
    </select>

    <select id="selectReleaseById" resultMap="release_result">
        select r.*,u.nick_name from `release` as r join users as u on r.user_Id=u.id WHERE r.id=#{id}
    </select>

    <resultMap id="newsTypeResult" type="com.cxgc.news_app.core.model.NewsType">
        <id property="id" column="id"/>
        <result property="typeName" column="type_name"/>
        <result property="typeDesc" column="type_desc"/>
    </resultMap>

    <select id="getNewsTypeById" resultMap="newsTypeResult">
        select * from news_type where id = #{0}
    </select>


    <!--####################新闻数据统计#######################-->
    <resultMap id="getMaxCountOfNewsType" type="map">
        <result column="getMaxCountOfNewsType" property="getMaxCountOfNewsType"/>
    </resultMap>
    <resultMap id="getMinCountOfNewsType" type="map">
        <result column="getMinCountOfNewsType" property="getMinCountOfNewsType"/>
    </resultMap>
    <resultMap id="getTop10News" type="map">
        <result column="getTop10News" property="getTop10News"/>
    </resultMap>
    <resultMap id="getTop10Release" type="map">
        <result column="getTop10Release" property="getTop10Release"/>
    </resultMap>


    <select id="getMaxCountOfNewsType" resultType="map">
SELECT t.news_type_id,t.type_name,(t1.ac+t.ac) as access_counts,(t.counts+t1.counts) as cs
FROM (

    SELECT news_type_id,nt.type_name,sum(access_count) as ac,count(1) as counts
    FROM news n JOIN news_type nt on n.news_type_id = nt.id
    where news_type_id is NOT NULL GROUP BY news_type_id
)t

JOIN (
    SELECT news_type_id,nt.type_name as type_name,sum(access_count) as ac ,count(1) as counts
    FROM `release` r join news_type nt on r.news_type_id = nt.id
    where news_type_id is NOT NULL GROUP BY news_type_id
)t1
ON t.news_type_id = t1.news_type_id
where t.news_type_id is NOT NULL GROUP BY t.news_type_id

ORDER BY access_counts
DESC
     LIMIT 1
    </select>
    <select id="getMinCountOfNewsType" resultType="map">
     SELECT t.news_type_id,t.type_name,(t1.ac+t.ac) as access_counts,(t.counts+t1.counts) as cs
FROM (

    SELECT news_type_id,nt.type_name,sum(access_count) as ac,count(1) as counts
    FROM news n JOIN news_type nt on n.news_type_id = nt.id
    where news_type_id is NOT NULL GROUP BY news_type_id
)t

JOIN (
    SELECT news_type_id,nt.type_name as type_name,sum(access_count) as ac ,count(1) as counts
    FROM `release` r join news_type nt on r.news_type_id = nt.id
    where news_type_id is NOT NULL GROUP BY news_type_id
)t1
ON t.news_type_id = t1.news_type_id
where t.news_type_id is NOT NULL GROUP BY t.news_type_id

ORDER BY access_counts
     LIMIT 1
    </select>
    <select id="getTop10News" resultMap="news_result">
SELECT n.*,access_count from news  n ORDER BY access_count DESC
     LIMIT 10
    </select>
    <select id="getTop10Release" resultMap="release_result">
SELECT r.*,access_count from `release`  r ORDER BY access_count DESC
     LIMIT 10
    </select>
</mapper>




